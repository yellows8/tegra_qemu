/*
 * ARM NVIDIA X1 emulation.
 *
 * Copyright (c) yellows8
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful, but WITHOUT
 *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 *  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 *
 *  You should have received a copy of the GNU General Public License along
 *  with this program; if not, see <http://www.gnu.org/licenses/>.
 */

// Based on tegra2 device code by digetx.

#define CONFIG_ARCH_TEGRA_21x_SOC

#include "tegra_common.h"

#include "hw/sysbus.h"

#include "iomap.h"
#include "tegra_trace.h"

#define TYPE_TEGRA_PINMUXAUX "tegra.pinmuxaux"
#define TEGRA_PINMUXAUX(obj) OBJECT_CHECK(tegra_pinmuxaux, (obj), TYPE_TEGRA_PINMUXAUX)
#define DEFINE_REG32(reg) reg##_t reg
#define WR_MASKED(r, d, m)  r = (r & ~m##_WRMASK) | (d & m##_WRMASK)

typedef struct tegra_pinmuxaux_state {
    SysBusDevice parent_obj;

    MemoryRegion iomem;
    uint32_t regs[0x294>>2];
} tegra_pinmuxaux;

static const VMStateDescription vmstate_tegra_pinmuxaux = {
    .name = TYPE_TEGRA_PINMUXAUX,
    .version_id = 1,
    .minimum_version_id = 1,
    .fields = (VMStateField[]) {
        VMSTATE_UINT32_ARRAY(regs, tegra_pinmuxaux, 0x294>>2),
        VMSTATE_END_OF_LIST()
    }
};

static uint32_t tegra_pinmuxaux_regdef_tegrax1_reset_table[] = {
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC1_CLK_0, 0x0, 0x00002074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC1_CMD_0, 0x4, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC1_DAT3_0, 0x8, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC1_DAT2_0, 0xC, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC1_DAT1_0, 0x10, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC1_DAT0_0, 0x14, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC3_CLK_0, 0x1C, 0x00002074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC3_CMD_0, 0x20, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC3_DAT0_0, 0x24, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC3_DAT1_0, 0x28, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC3_DAT2_0, 0x2C, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SDMMC3_DAT3_0, 0x30, 0x00002078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PEX_L0_RST_N_0, 0x38, 0x00000460)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PEX_L0_CLKREQ_N_0, 0x3C, 0x00000470)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PEX_WAKE_N_0, 0x40, 0x00000470)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PEX_L1_RST_N_0, 0x44, 0x00000460)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PEX_L1_CLKREQ_N_0, 0x48, 0x00000470)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SATA_LED_ACTIVE_0, 0x4C, 0x00000060)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI1_MOSI_0, 0x50, 0x0000E074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI1_MISO_0, 0x54, 0x0000E074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI1_SCK_0, 0x58, 0x0000E074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI1_CS0_0, 0x5C, 0x0000E078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI1_CS1_0, 0x60, 0x0000E078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI2_MOSI_0, 0x64, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI2_MISO_0, 0x68, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI2_SCK_0, 0x6C, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI2_CS0_0, 0x70, 0x00006078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI2_CS1_0, 0x74, 0x00006078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI4_MOSI_0, 0x78, 0x0000E074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI4_MISO_0, 0x7C, 0x0000E074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI4_SCK_0, 0x80, 0x0000E074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPI4_CS0_0, 0x84, 0x0000E078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_QSPI_SCK_0, 0x88, 0x00003078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_QSPI_CS_N_0, 0x8C, 0x00003078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_QSPI_IO0_0, 0x90, 0x00003078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_QSPI_IO1_0, 0x94, 0x00003078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_QSPI_IO2_0, 0x98, 0x00003078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_QSPI_IO3_0, 0x9C, 0x00003078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DMIC1_CLK_0, 0xA4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DMIC1_DAT_0, 0xA8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DMIC2_CLK_0, 0xAC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DMIC2_DAT_0, 0xB0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DMIC3_CLK_0, 0xB4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DMIC3_DAT_0, 0xB8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GEN1_I2C_SCL_0, 0xBC, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GEN1_I2C_SDA_0, 0xC0, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GEN2_I2C_SCL_0, 0xC4, 0x00000572)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GEN2_I2C_SDA_0, 0xC8, 0x00000572)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GEN3_I2C_SCL_0, 0xCC, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GEN3_I2C_SDA_0, 0xD0, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM_I2C_SCL_0, 0xD4, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM_I2C_SDA_0, 0xD8, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PWR_I2C_SCL_0, 0xDC, 0x00000170)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PWR_I2C_SDA_0, 0xE0, 0x00000170)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART1_TX_0, 0xE4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART1_RX_0, 0xE8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART1_RTS_0, 0xEC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART1_CTS_0, 0xF0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART2_TX_0, 0xF4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART2_RX_0, 0xF8, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART2_RTS_0, 0xFC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART2_CTS_0, 0x100, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART3_TX_0, 0x104, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART3_RX_0, 0x108, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART3_RTS_0, 0x10C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART3_CTS_0, 0x110, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART4_TX_0, 0x114, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART4_RX_0, 0x118, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART4_RTS_0, 0x11C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_UART4_CTS_0, 0x120, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP1_FS_0, 0x124, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP1_DIN_0, 0x128, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP1_DOUT_0, 0x12C, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP1_SCLK_0, 0x130, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP2_FS_0, 0x134, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP2_DIN_0, 0x138, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP2_DOUT_0, 0x13C, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP2_SCLK_0, 0x140, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP4_FS_0, 0x144, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP4_DIN_0, 0x148, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP4_DOUT_0, 0x14C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DAP4_SCLK_0, 0x150, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM1_MCLK_0, 0x154, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM2_MCLK_0, 0x158, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_JTAG_RTCK_0, 0x15C, 0x00000068)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CLK_32K_IN_0, 0x160, 0x00000000)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CLK_32K_OUT_0, 0x164, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BATT_BCL_0, 0x168, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CLK_REQ_0, 0x16C, 0x00000040)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CPU_PWR_REQ_0, 0x170, 0x00000040)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_PWR_INT_N_0, 0x174, 0x00000040)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SHUTDOWN_0, 0x178, 0x00000040)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CORE_PWR_REQ_0, 0x17C, 0x00000040)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_AUD_MCLK_0, 0x180, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DVFS_PWM_0, 0x184, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DVFS_CLK_0, 0x188, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_X1_AUD_0, 0x18C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_X3_AUD_0, 0x190, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PCC7_0, 0x194, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_HDMI_CEC_0, 0x198, 0x00000570)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_HDMI_INT_DP_HPD_0, 0x19C, 0x00000574)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPDIF_OUT_0, 0x1A0, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_SPDIF_IN_0, 0x1A4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_USB_VBUS_EN0_0, 0x1A8, 0x00000560)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_USB_VBUS_EN1_0, 0x1AC, 0x00000560)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_DP_HPD0_0, 0x1B0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_WIFI_EN_0, 0x1B4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_WIFI_RST_0, 0x1B8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_WIFI_WAKE_AP_0, 0x1BC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_AP_WAKE_BT_0, 0x1C0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BT_RST_0, 0x1C4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BT_WAKE_AP_0, 0x1C8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_AP_WAKE_NFC_0, 0x1CC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_NFC_EN_0, 0x1D0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_NFC_INT_0, 0x1D4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPS_EN_0, 0x1D8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPS_RST_0, 0x1DC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM_RST_0, 0x1E0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM_AF_EN_0, 0x1E4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM_FLASH_EN_0, 0x1E8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM1_PWDN_0, 0x1EC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM2_PWDN_0, 0x1F0, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_CAM1_STROBE_0, 0x1F4, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_LCD_TE_0, 0x1F8, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_LCD_BL_PWM_0, 0x1FC, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_LCD_BL_EN_0, 0x200, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_LCD_RST_0, 0x204, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_LCD_GPIO1_0, 0x208, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_LCD_GPIO2_0, 0x20C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_AP_READY_0, 0x210, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_TOUCH_RST_0, 0x214, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_TOUCH_CLK_0, 0x218, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_MODEM_WAKE_AP_0, 0x21C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_TOUCH_INT_0, 0x220, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_MOTION_INT_0, 0x224, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_ALS_PROX_INT_0, 0x228, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_TEMP_ALERT_0, 0x22C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BUTTON_POWER_ON_0, 0x230, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BUTTON_VOL_UP_0, 0x234, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BUTTON_VOL_DOWN_0, 0x238, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BUTTON_SLIDE_SW_0, 0x23C, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_BUTTON_HOME_0, 0x240, 0x00000078)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PA6_0, 0x244, 0x00000030)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PE6_0, 0x248, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PE7_0, 0x24C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PH6_0, 0x250, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK0_0, 0x254, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK1_0, 0x258, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK2_0, 0x25C, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK3_0, 0x260, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK4_0, 0x264, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK5_0, 0x268, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK6_0, 0x26C, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PK7_0, 0x270, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PL0_0, 0x274, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PL1_0, 0x278, 0x00006074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PZ0_0, 0x27C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PZ1_0, 0x280, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PZ2_0, 0x284, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PZ3_0, 0x288, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PZ4_0, 0x28C, 0x00000074)
    TEGRA_REGDEF_TABLE_RESET(PINMUX_AUX_GPIO_PZ5_0, 0x290, 0x00000074)
};

static uint64_t tegra_pinmuxaux_priv_read(void *opaque, hwaddr offset,
                                        unsigned size)
{
    tegra_pinmuxaux *s = opaque;
    uint64_t ret = 0;

    assert(offset < sizeof(s->regs));

    ret = s->regs[offset/sizeof(uint32_t)] & ((1ULL<<size*8)-1);

    TRACE_READ(s->iomem.addr, offset, ret);

    return ret;
}

static void tegra_pinmuxaux_priv_write(void *opaque, hwaddr offset,
                                     uint64_t value, unsigned size)
{
    tegra_pinmuxaux *s = opaque;

    assert(offset < sizeof(s->regs));

    TRACE_WRITE(s->iomem.addr, offset, 0, value);

    s->regs[offset/sizeof(uint32_t)] = (s->regs[offset/sizeof(uint32_t)] & ~((1ULL<<size*8)-1)) | value;
}

static void tegra_pinmuxaux_priv_reset(DeviceState *dev)
{
    tegra_pinmuxaux *s = TEGRA_PINMUXAUX(dev);

    memset(s->regs, 0, sizeof(s->regs));

    if (tegra_board >= TEGRAX1_BOARD) {
        for (size_t i=0; i<sizeof(tegra_pinmuxaux_regdef_tegrax1_reset_table)/sizeof(uint32_t); i+=2) {
            s->regs[tegra_pinmuxaux_regdef_tegrax1_reset_table[i]>>2] = tegra_pinmuxaux_regdef_tegrax1_reset_table[i+1];
        }
    }
}

static const MemoryRegionOps tegra_pinmuxaux_mem_ops = {
    .read = tegra_pinmuxaux_priv_read,
    .write = tegra_pinmuxaux_priv_write,
    .endianness = DEVICE_NATIVE_ENDIAN,
};

static void tegra_pinmuxaux_priv_realize(DeviceState *dev, Error **errp)
{
    tegra_pinmuxaux *s = TEGRA_PINMUXAUX(dev);

    memory_region_init_io(&s->iomem, OBJECT(dev), &tegra_pinmuxaux_mem_ops, s,
                          TYPE_TEGRA_PINMUXAUX, TEGRA_PINMUX_AUX_SIZE);
    sysbus_init_mmio(SYS_BUS_DEVICE(dev), &s->iomem);
}

static void tegra_pinmuxaux_class_init(ObjectClass *klass, void *data)
{
    DeviceClass *dc = DEVICE_CLASS(klass);

    dc->realize = tegra_pinmuxaux_priv_realize;
    dc->vmsd = &vmstate_tegra_pinmuxaux;
    dc->reset = tegra_pinmuxaux_priv_reset;
}

static const TypeInfo tegra_pinmuxaux_info = {
    .name = TYPE_TEGRA_PINMUXAUX,
    .parent = TYPE_SYS_BUS_DEVICE,
    .instance_size = sizeof(tegra_pinmuxaux),
    .class_init = tegra_pinmuxaux_class_init,
};

static void tegra_pinmuxaux_register_types(void)
{
    type_register_static(&tegra_pinmuxaux_info);
}

type_init(tegra_pinmuxaux_register_types)
